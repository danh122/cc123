<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="viewTitle">Xem Paste</title>
    <link rel="stylesheet" href="style.css">
    </head>
<body class="dark-mode">

    <div class="container">
        
        <div id="statusMessage" class="note-card" style="display:none; background-color: #3e4451; color: #fff;"></div>

        <div id="pasteView" class="view-card">
            
            <h2 id="pasteHeader"></h2>
            
            <div class="paste-metadata">
                <span id="pasteLanguage" class="tag"></span>
                <span id="pasteViews">0 l∆∞·ª£t xem</span>
                <span id="pasteDate"></span>
            </div>
            
            <div class="paste-actions">
                <span id="saveStatusDot" class="status-dot"></span> 
                <button id="rawBtn">üíæ Raw</button> 
                <button id="copyLinkBtn">üîó Copy Link</button>
            </div>

            <div id="codeContainer">
                </div>
            
            <p id="autosaveStatus" style="font-size: 0.8em; margin-top: 15px; color: #7f8c9d;"></p>
        </div>

        <div class="back-link">
            <a href="index.html">üè† T·∫°o Paste M·ªõi</a>
        </div>

    </div>
    
    <script>
// LOGIC CH√çNH: L·∫§Y, HI·ªÇN TH·ªä V√Ä AUTO SAVE
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const pasteId = urlParams.get('id');
    const status = urlParams.get('status');
    const codeContainer = document.getElementById('codeContainer');
    const rawBtn = document.getElementById('rawBtn');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const autosaveStatus = document.getElementById('autosaveStatus');
    const saveStatusDot = document.getElementById('saveStatusDot');
    const statusMessage = document.getElementById('statusMessage');
    
    const API_BASE_URL = 'https://api-note-519q.onrender.com';
    
    let currentPasteData = null;
    let autosaveTimeout = null;
    let isEditing = false; 
    let currentLanguage = 'text';

    // --- H√†m C·∫≠p nh·∫≠t s·ªë d√≤ng (Line Number Simulation) ---
    const updateLineNumbers = (textarea, lineNumberDiv) => {
        const lines = textarea.value.split('\n');
        const lineNumbers = lines.map((_, i) => i + 1).join('\n');
        lineNumberDiv.textContent = lineNumbers;
        lineNumberDiv.scrollTop = textarea.scrollTop;
    };

    // --- H√†m T·∫°o Editor ---
    const createEditor = (content) => {
        const editorWrapper = document.createElement('div');
        editorWrapper.className = 'editor-wrapper';

        const lineNumberDiv = document.createElement('div');
        lineNumberDiv.className = 'line-numbers';
        
        const textarea = document.createElement('textarea');
        textarea.id = 'editableContent';
        textarea.value = content;
        textarea.className = 'editor-textarea'; 
        
        const update = () => updateLineNumbers(textarea, lineNumberDiv);
        update();
        
        textarea.oninput = (e) => {
            autoSave(e.target.value);
            update();
        };
        
        textarea.onscroll = () => {
            lineNumberDiv.scrollTop = textarea.scrollTop;
        };
        
        editorWrapper.appendChild(lineNumberDiv);
        editorWrapper.appendChild(textarea);
        
        return editorWrapper;
    };


    // --- H√†m T·ª± ƒë·ªông L∆∞u ---
    const autoSave = async (content, saveNow = false) => {
        if (!isEditing) return;
        clearTimeout(autosaveTimeout);
        
        // B·∫≠t tr·∫°ng th√°i ƒêang L∆∞u (Ch·∫•m cam)
        saveStatusDot.classList.remove('saved-mode');
        saveStatusDot.classList.add('saving-mode');
        
        const performSave = async () => {
            autosaveStatus.textContent = "ƒêang l∆∞u...";
            try {
                const response = await fetch(`${API_BASE_URL}/api/paste/${pasteId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                });

                const result = await response.json();

                if (response.ok) {
                    // B·∫≠t tr·∫°ng th√°i ƒê√£ L∆∞u (Ch·∫•m xanh)
                    saveStatusDot.classList.remove('saving-mode');
                    saveStatusDot.classList.add('saved-mode');
                    
                    autosaveStatus.textContent = `‚úÖ ƒê√£ l∆∞u t·ª± ƒë·ªông l√∫c: ${new Date().toLocaleTimeString('vi-VN')}`;
                    currentPasteData.content = content; 
                } else {
                    saveStatusDot.classList.remove('saving-mode');
                    saveStatusDot.classList.add('saved-mode'); 
                    autosaveStatus.textContent = `L∆∞u th·∫•t b·∫°i: ${result.message}`;
                }
            } catch (error) {
                saveStatusDot.classList.remove('saving-mode');
                saveStatusDot.classList.add('saved-mode'); 
                autosaveStatus.textContent = "L·ªói k·∫øt n·ªëi API, kh√¥ng th·ªÉ l∆∞u.";
                console.error("AutoSave Error:", error);
            }
        };

        if (saveNow) {
            await performSave();
        } else {
            autosaveTimeout = setTimeout(performSave, 3000); // 3 gi√¢y
        }
    };


    // --- T·∫£i Paste Ban ƒë·∫ßu ---
    const loadPaste = async () => {
        if (!pasteId) {
            document.getElementById('pasteView').innerHTML = "<h2 style='color: #fff;'>L·ªói: Kh√¥ng t√¨m th·∫•y ID Paste trong URL.</h2>";
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/paste/${pasteId}`);
            currentPasteData = await response.json();

            if (response.ok) {
                // HI·ªÇN TH·ªä D·ªÆ LI·ªÜU CHUNG
                document.getElementById('pasteHeader').textContent = currentPasteData.title || "Kh√¥ng ti√™u ƒë·ªÅ";
                currentLanguage = currentPasteData.language; 
                document.getElementById('pasteLanguage').textContent = currentLanguage.toUpperCase();
                document.getElementById('pasteViews').textContent = `${currentPasteData.views} l∆∞·ª£t xem`;
                document.getElementById('pasteDate').textContent = new Date(currentPasteData.createdAt).toLocaleDateString('vi-VN');
                
                if (status === 'success') {
                    statusMessage.style.display = 'block';
                    statusMessage.style.backgroundColor = '#2ecc71';
                    statusMessage.style.color = '#fff';
                    statusMessage.innerHTML = `<p style="font-weight: bold;">‚úÖ Paste ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!</p>`;
                }
                
                // T·ª∞ ƒê·ªòNG B·∫¨T CH·∫æ ƒê·ªò CH·ªàNH S·ª¨A
                isEditing = true; 
                const editorElement = createEditor(currentPasteData.content);
                codeContainer.innerHTML = '';
                codeContainer.appendChild(editorElement);
                editorElement.querySelector('textarea').focus(); 
                
                // Hi·ªÉn th·ªã tr·∫°ng th√°i Auto Save
                autosaveStatus.style.display = 'block';
                saveStatusDot.style.display = 'inline-block';

            } else {
                document.getElementById('pasteView').innerHTML = `<h2 style='color: #fff;'>L·ªói: ${currentPasteData.message || 'Kh√¥ng th·ªÉ t·∫£i Paste'}</h2>`;
            }
        } catch (error) {
            document.getElementById('pasteView').innerHTML = "<h2 style='color: #fff;'>L·ªói k·∫øt n·ªëi API. ƒê·∫£m b·∫£o Server Node.js ƒëang ch·∫°y t·∫°i c·ªïng 3000.</h2>";
        }
    };

    if (pasteId) {
        loadPaste();
    }
    
    // ƒêƒÉng k√Ω s·ª± ki·ªán (N√∫t Ch·ªânh s·ª≠a ƒë√£ ƒë∆∞·ª£c lo·∫°i b·ªè)
    rawBtn.onclick = () => { window.open(`${API_BASE_URL}/api/paste/${pasteId}/raw`, '_blank'); };
    copyLinkBtn.onclick = () => { navigator.clipboard.writeText(window.location.href); alert('ƒê√£ sao ch√©p link!'); };
});
    </script>
